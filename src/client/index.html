<!DOCTYPE html>
<html>
<head>
	<title>Report on Trends</title>
	
	<meta name=description content="">
	<meta charset=utf-8>
	<meta name=viewport content="width=device-width, initial-scale=1">

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css">
	<script src="https://d3js.org/d3.v5.min.js"></script>

	<style type="text/css">
		div{
			white-space: nowrap;
		}

		.card{
			padding: 2em;
		}
	</style>
</head>
<body>
	<header class="jumbotron">
		<h1>Data</h1>
	</header>
	<main class="container mx-4 px-4">
		<div id="a1" class="card"></div>
		<div id="a2" class="card"></div>
		<div id="a3" class="card"></div>
		<div id="a4" class="card"></div>
	</main>

	<script type="text/javascript">
		const t = d3.transition()
			.duration(7000);

		Promise.all([
			fetch('/api/colors')
			.then(blob => blob.json()),
			fetch('/api/trends')
			.then(blob => blob.json())
			.then(data => data.slice(0, 10))
		])
		.then(res =>{
			let [colors, data] = res;
			const keys = Object.keys(data[0]);
			console.log(colors, data, keys);

			////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////

			const barKeys = ['vowels', 'caps', 'katherines'];
			const cardWidth = document.getElementById('a2').clientWidth - 120;
			const barWidth = cardWidth / data.length / 4;
			const barX = d3.scaleLinear()
				.domain([0, data.length])
				.range([0, cardWidth]);
				console.log(data.length * barWidth * barKeys.length);
			const barY = d3.scaleLinear()
				.domain([0, Math.max(...data.map(i => Math.max( ...barKeys.map(key => i[key]) )))])
				.range([0, 100]);

			d3.select('#a2')
				.append('svg')
				.selectAll('g')
				.data(data)
				.enter()
				.append('g')
				.attr('transform', function(d, i){ return `translate(${barX(i)}, 0)`})
				.selectAll('rect')
				.data(function(data){
					return barKeys.map(function(key){return {key:key, val: data[key]} });
				})
				.enter()
				.append('rect')
				.attr('x', function(d, i){return barWidth*i})
				.attr('height', function(d){return barY(d.val) + 'px'})
				.attr('width', barWidth + 'px')
				.attr('fill', colors[0][0])
				.text(function(d){return d.key});


			////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////
			d3.select('#a1')
				.selectAll('div')
				.data(data.slice(0, 10))
				.enter()
				.append('div')
				.attr('class', 'bar__title')
				.style('width', function(d){return d.text.length *10 + 'px'})
				.style('background', colors[0][1])

				.append('div')
				.attr('class', 'bar__extras')
				.style('width', function(d){return (d.extras + d.nums) * 10 + 'px'})
				.style('background', colors[0][1])
				.text(function(d){return d.text})
				.transition(t)
				.style('background', colors[0][0]);
		});
	</script>
</body>
</html>